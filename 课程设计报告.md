# 数据库课程设计

| | |
| -: | :- |
|题目|工业设备台账管理系统|
|班级|23级信息安全1班|
|学号|3123004792|
|姓名|梁奕航|

<div STYLE="page-break-after: always;"></div>

# 概论
## 选题以及意义
随着工业4.0时代的到来，制造业企业对于设备管理的需求日益增长。传统的设备管理方式多依赖纸质记录和人工统计，存在效率低下、数据易丢失、查询困难等问题。本系统旨在构建一个现代化的工业设备台账管理系统，实现设备信息的数字化管理。

**选题意义：**
1. **提高管理效率**：通过信息化手段，实现设备信息的快速录入、查询和统计，大幅提升设备管理效率。
2. **数据准确性**：采用数据库统一管理，避免人工记录错误，确保数据的准确性和一致性。
3. **决策支持**：通过统计分析功能，为管理层提供设备使用情况、维修趋势等数据支持，辅助决策。
4. **成本控制**：通过维修记录管理，帮助企业分析设备维护成本，优化维修策略。
5. **实践应用**：本系统贴近实际工业场景，具有较高的实用价值，可作为企业设备管理的参考方案。

## 相关技术介绍
### 前端技术
**React 18**：Facebook开发的JavaScript库，采用组件化开发模式，具有虚拟DOM、单向数据流等特性，能够高效构建用户界面。
**TypeScript**：Microsoft开发的JavaScript超集，增加了类型系统，提高代码的可维护性和健壮性。
**Vite**：新一代前端构建工具，采用ESM模块系统，具有极快的开发服务器启动速度和热更新能力。
**Ant Design**：企业级UI设计语言和React组件库，提供丰富的组件和良好的用户体验。

### 后端技术
**Node.js**：基于Chrome V8引擎的JavaScript运行时，采用事件驱动、非阻塞I/O模型，适合构建高性能的网络应用。
**Express**：Node.js的Web应用框架，提供简洁灵活的API，支持中间件、路由等功能。
**MySQL2**：MySQL数据库的Node.js驱动，支持Promise和async/await，提供连接池管理功能。

### 数据库技术
**MySQL**：开源的关系型数据库管理系统，具有高性能、高可靠性、易于使用等特点，广泛应用于Web应用开发。
**InnoDB存储引擎**：MySQL的默认存储引擎，支持事务、外键约束、行级锁定等特性，适合处理大量并发操作。


# 需求分析
1. 设备维修的增删查改
2. 设备维修纪律的关联查询
3. 车间设备统计、状态过滤、多条件筛选等

# 总体设计
## 数据库概念设计
根据需求分析，本系统涉及三个主要实体：车间（Workshop）、设备（Equipment）、维修记录（Maintenance）。

**实体属性：**
1. **车间（Workshop）**
   - 车间编号（workshop_id）：主属性
   - 车间名称（workshop_name）
   - 创建时间（created_at）
   - 更新时间（updated_at）

2. **设备（Equipment）**
   - 设备编号（equipment_id）：主属性
   - 型号（model）
   - 出厂日期（factory_date）
   - 采购价格（purchase_price）
   - 所属车间（workshop_id）：外键，关联车间
   - 负责人（responsible_person）
   - 设备状态（status）：枚举类型（在用、维修、报废）
   - 创建时间（created_at）
   - 更新时间（updated_at）

3. **维修记录（Maintenance）**
   - 维修单号（maintenance_id）：主属性
   - 设备编号（equipment_id）：外键，关联设备
   - 维修时间（maintenance_time）
   - 故障描述（fault_description）
   - 故障类型（fault_type）
   - 维修费用（maintenance_cost）
   - 创建时间（created_at）
   - 更新时间（updated_at）

**实体关系：**
- 车间与设备：一对多关系（1:N）。一个车间可以有多台设备，一台设备只属于一个车间。
- 设备与维修记录：一对多关系（1:N）。一台设备可以有多条维修记录，一条维修记录只属于一台设备。

**ER图描述：**

```
车间（Workshop）                   设备（Equipment）
┌─────────────┐                   ┌─────────────┐
│ workshop_id │◄──────────────────│ workshop_id │（外键）
│ workshop_   │   1              N │ equipment_  │
│   name      │                   │   id        │
│ created_at  │                   │ model       │
│ updated_at  │                   │ factory_    │
└─────────────┘                   │   date      │
                                  │ purchase_   │
                                  │   price     │
                                  │ responsible │
                                  │   _person   │
                                  │ status      │
                                  │ created_at  │
                                  │ updated_at  │
                                  └──────┬──────┘
                                         │ 1
                                         │
                                         │ N
                                  ┌──────▼──────┐
                                  │ Maintenance │
                                  │（维修记录）  │
                                  ├─────────────┤
                                  │ maintenance │
                                  │   _id       │
                                  │ equipment_  │（外键）
                                  │   id        │
                                  │ maintenance │
                                  │   _time     │
                                  │ fault_      │
                                  │   desc      │
                                  │ fault_type  │
                                  │ maintenance │
                                  │   _cost     │
                                  │ created_at  │
                                  │ updated_at  │
                                  └─────────────┘
```

## 数据库逻辑设计

### 关系模式
1. **Workshop（车间表）**
   - 属性：workshop_id, workshop_name, created_at, updated_at
   - 主码：workshop_id
   - 函数依赖：workshop_id → workshop_name, created_at, updated_at

2. **Equipment（设备表）**
   - 属性：equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status, created_at, updated_at
   - 主码：equipment_id
   - 外码：workshop_id → Workshop(workshop_id)
   - 函数依赖：
     - equipment_id → model, factory_date, purchase_price, workshop_id, responsible_person, status, created_at, updated_at
     - workshop_id → workshop_name（通过外键关联）

3. **Maintenance（维修记录表）**
   - 属性：maintenance_id, equipment_id, maintenance_time, fault_description, fault_type, maintenance_cost, created_at, updated_at
   - 主码：maintenance_id
   - 外码：equipment_id → Equipment(equipment_id)
   - 函数依赖：
     - maintenance_id → equipment_id, maintenance_time, fault_description, fault_type, maintenance_cost, created_at, updated_at
     - equipment_id → model, workshop_id等（通过外键关联）

### 范式分析
**Workshop表：**
- 所有非主属性完全依赖于主码workshop_id，无传递依赖
- **范式级别：3NF**

**Equipment表：**
- 所有非主属性完全依赖于主码equipment_id
- workshop_id是外键，通过关联查询可获得workshop_name，但不在本表中存储，避免冗余
- **范式级别：3NF**

**Maintenance表：**
- 所有非主属性完全依赖于主码maintenance_id
- equipment_id是外键，通过关联查询可获得设备信息，但不在本表中存储
- **范式级别：3NF**

所有关系模式均满足第三范式（3NF）要求，数据冗余最小，更新异常和删除异常得到有效控制。

## 数据库与数据表设计 ——物理结构设计
### 1. 车间表（workshop）
| 字段名 | 数据类型 | 宽度 | 数据约束 | 说明 |
| ------ | -------- | ---- | -------- | ---- |
| workshop_id | VARCHAR | 50 | PRIMARY KEY | 车间编号 |
| workshop_name | VARCHAR | 100 | NOT NULL | 车间名称 |
| created_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 2. 设备信息表（equipment）
| 字段名 | 数据类型 | 宽度 | 数据约束 | 说明 |
| ------ | -------- | ---- | -------- | ---- |
| equipment_id | VARCHAR | 50 | PRIMARY KEY | 设备编号 |
| model | VARCHAR | 100 | NOT NULL | 型号 |
| factory_date | DATE | - | NULL | 出厂日期 |
| purchase_price | DECIMAL | 10,2 | NOT NULL | 采购价格 |
| workshop_id | VARCHAR | 50 | NOT NULL, FOREIGN KEY | 所属车间 |
| responsible_person | VARCHAR | 50 | NOT NULL | 负责人 |
| status | ENUM | - | NOT NULL, DEFAULT '在用' | 设备状态（在用/维修/报废） |
| created_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: equipment_id
- INDEX idx_workshop_id: workshop_id
- INDEX idx_status: status
- FOREIGN KEY: workshop_id REFERENCES workshop(workshop_id) ON DELETE RESTRICT ON UPDATE CASCADE

### 3. 维修记录表（maintenance）
| 字段名 | 数据类型 | 宽度 | 数据约束 | 说明 |
| ------ | -------- | ---- | -------- | ---- |
| maintenance_id | VARCHAR | 50 | PRIMARY KEY | 维修单号 |
| equipment_id | VARCHAR | 50 | NOT NULL, FOREIGN KEY | 设备编号 |
| maintenance_time | DATETIME | - | NOT NULL | 维修时间 |
| fault_description | TEXT | - | NOT NULL | 故障描述 |
| fault_type | VARCHAR | 100 | NULL | 故障类型 |
| maintenance_cost | DECIMAL | 10,2 | NOT NULL, DEFAULT 0, CHECK >= 0 | 维修费用 |
| created_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY: maintenance_id
- INDEX idx_equipment_id: equipment_id
- INDEX idx_maintenance_time: maintenance_time
- INDEX idx_equipment_time: (equipment_id, maintenance_time)
- INDEX idx_fault_type: fault_type
- FOREIGN KEY: equipment_id REFERENCES equipment(equipment_id) ON DELETE RESTRICT ON UPDATE CASCADE
- CHECK约束: maintenance_cost >= 0

## 软件方面的设计
### 系统架构设计
本系统采用前后端分离的架构设计：
**前端架构：**
- **技术栈**：React 18 + TypeScript + Vite + Ant Design
- **路由管理**：React Router
- **状态管理**：React Hooks（useState, useEffect）
- **HTTP客户端**：Fetch API封装
- **UI组件库**：Ant Design

**后端架构：**
- **技术栈**：Node.js + Express + TypeScript + MySQL2
- **路由设计**：RESTful API风格
- **数据库连接**：连接池管理
- **数据验证**：Zod库进行请求参数验证

### 功能模块设计
**1. 设备管理模块**
- 设备列表展示（支持分页、排序）
- 设备信息查询（多条件筛选：编号、型号、车间、状态）
- 设备新增、编辑、删除
- 设备详情查看
- 设备维修历史关联查询

**2. 维修记录管理模块**
- 维修记录列表展示
- 维修记录查询（按设备、车间、故障类型、时间范围筛选）
- 维修记录新增、编辑、删除
- 设备维修历史查询

**3. 统计分析模块**
- 车间设备统计（总数、在用数、维修次数）
- 设备状态统计（在用/维修/报废数量）
- 维修趋势分析（按月统计，支持按车间/设备筛选）

**4. 车间管理模块**
- 车间列表查询
- 车间信息展示

### 用户界面设计

**主要页面：**

1. **设备列表页面**：展示所有设备信息，支持搜索、筛选、新增、编辑、删除操作
2. **设备详情页面**：展示设备详细信息及维修历史
3. **维修记录列表页面**：展示所有维修记录，支持多条件筛选
4. **统计分析页面**：以图表形式展示各类统计数据

**界面特点：**
- 采用Ant Design组件库，界面美观统一
- 响应式设计，适配不同屏幕尺寸
- 操作反馈及时，用户体验良好


# 数据库详细设计
## 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS equipment_management 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**说明**：创建名为`equipment_management`的数据库，使用utf8mb4字符集和utf8mb4_unicode_ci排序规则，支持中文和特殊字符。

**学号3123004792 梁奕航**

## 创建数据库中的表
### 1. 创建车间信息表

```sql
CREATE TABLE IF NOT EXISTS workshop (
    workshop_id VARCHAR(50) PRIMARY KEY COMMENT '车间编号',
    workshop_name VARCHAR(100) NOT NULL COMMENT '车间名称',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='车间信息表';
```

**说明**：创建车间信息表，主键为workshop_id，包含车间名称和时间戳字段。

### 2. 创建设备信息表

```sql
CREATE TABLE IF NOT EXISTS equipment (
    equipment_id VARCHAR(50) PRIMARY KEY COMMENT '设备编号',
    model VARCHAR(100) NOT NULL COMMENT '型号',
    factory_date DATE COMMENT '出厂日期',
    purchase_price DECIMAL(10, 2) NOT NULL COMMENT '采购价格',
    workshop_id VARCHAR(50) NOT NULL COMMENT '所属车间',
    responsible_person VARCHAR(50) NOT NULL COMMENT '负责人',
    status ENUM('在用', '维修', '报废') NOT NULL DEFAULT '在用' COMMENT '设备状态',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (workshop_id) REFERENCES workshop(workshop_id) ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_workshop_id (workshop_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='设备信息表';
```

**说明**：创建设备信息表，主键为equipment_id，外键workshop_id关联车间表，设置状态字段索引和车间索引以提高查询性能。

### 3. 创建维修记录表

```sql
CREATE TABLE IF NOT EXISTS maintenance (
    maintenance_id VARCHAR(50) PRIMARY KEY COMMENT '维修单号',
    equipment_id VARCHAR(50) NOT NULL COMMENT '设备编号',
    maintenance_time DATETIME NOT NULL COMMENT '维修时间',
    fault_description TEXT NOT NULL COMMENT '故障描述',
    fault_type VARCHAR(100) COMMENT '故障类型',
    maintenance_cost DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT '维修费用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (equipment_id) REFERENCES equipment(equipment_id) ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_equipment_id (equipment_id),
    INDEX idx_maintenance_time (maintenance_time),
    INDEX idx_equipment_time (equipment_id, maintenance_time),
    INDEX idx_fault_type (fault_type),
    CHECK (maintenance_cost >= 0)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='维修记录表';
```

**说明**：创建维修记录表，主键为maintenance_id，外键equipment_id关联设备表，创建多个索引优化查询性能，设置CHECK约束确保维修费用非负。

## 创建索引
给出对应的SQL以及说明

索引已在表创建时定义，以下是索引说明：

1. **equipment表索引：**
   - `idx_workshop_id`：车间编号索引，优化按车间查询设备的性能
   - `idx_status`：设备状态索引，优化按状态筛选的性能

2. **maintenance表索引：**
   - `idx_equipment_id`：设备编号索引，优化按设备查询维修记录的性能
   - `idx_maintenance_time`：维修时间索引，优化按时间排序和筛选的性能
   - `idx_equipment_time`：设备编号和维修时间的联合索引，优化设备维修历史查询
   - `idx_fault_type`：故障类型索引，优化按故障类型筛选的性能

## 创建视图（如果需要的话）

创建设备详情视图，方便查询设备及其所属车间信息：

```sql
CREATE OR REPLACE VIEW v_equipment_detail AS
SELECT 
    e.equipment_id,
    e.model,
    e.factory_date,
    e.purchase_price,
    e.workshop_id,
    w.workshop_name,
    e.responsible_person,
    e.status,
    e.created_at,
    e.updated_at
FROM equipment e
LEFT JOIN workshop w ON e.workshop_id = w.workshop_id;
```

**说明**：创建设备详情视图，将设备表和车间表关联，方便查询设备及其所属车间名称。

## 数据库API设计及实现 
### 1. 设备管理API

#### 1.1 查询设备列表（支持多条件筛选）

**功能**：根据设备编号、型号、车间、状态等条件查询设备列表。

**输入参数**：equipment_id（可选）、model（可选）、workshop_id（可选）、status（可选）、keyword（可选）

**SQL：**
```sql
SELECT e.*, w.workshop_name 
FROM equipment e 
LEFT JOIN workshop w ON e.workshop_id = w.workshop_id 
WHERE 1=1
  AND (? IS NULL OR e.equipment_id = ?)
  AND (? IS NULL OR e.model LIKE ?)
  AND (? IS NULL OR e.workshop_id = ?)
  AND (? IS NULL OR e.status = ?)
  AND (? IS NULL OR (e.equipment_id LIKE ? OR e.model LIKE ? OR w.workshop_name LIKE ?))
ORDER BY e.equipment_id;
```

**说明**：多表连接查询，支持多条件筛选，使用LIKE实现模糊查询。

#### 1.2 查询单个设备详情

**功能**：根据设备编号查询设备详细信息。

**输入参数**：equipment_id

**SQL：**
```sql
SELECT e.*, w.workshop_name 
FROM equipment e 
LEFT JOIN workshop w ON e.workshop_id = w.workshop_id 
WHERE e.equipment_id = ?;
```

**说明**：通过设备编号查询设备信息及所属车间名称。

#### 1.3 新增设备

**功能**：添加新设备信息。

**输入参数**：equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status

**SQL：**
```sql
INSERT INTO equipment (equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status) 
VALUES (?, ?, ?, ?, ?, ?, ?);
```

**说明**：插入新设备记录，系统自动设置created_at和updated_at字段。

#### 1.4 修改设备信息

**功能**：更新设备信息。

**输入参数**：equipment_id（WHERE条件），其他字段可选

**SQL：**
```sql
UPDATE equipment 
SET model = ?, factory_date = ?, purchase_price = ?, workshop_id = ?, responsible_person = ?, status = ? 
WHERE equipment_id = ?;
```

**说明**：根据设备编号更新设备信息，系统自动更新updated_at字段。

#### 1.5 删除设备

**功能**：删除设备（仅当设备无维修记录时）。

**输入参数**：equipment_id

**SQL：**
```sql
-- 先检查是否有维修记录
SELECT COUNT(*) as count FROM maintenance WHERE equipment_id = ?;

-- 如果没有维修记录，执行删除
DELETE FROM equipment WHERE equipment_id = ?;
```

**说明**：删除前检查设备是否存在维修记录，保证数据完整性。

### 2. 维修记录管理API

#### 2.1 查询维修记录列表（多条件筛选）

**功能**：根据设备、车间、故障类型、时间范围等条件查询维修记录。

**输入参数**：equipment_id（可选）、workshop_id（可选）、fault_type（可选）、maintenance_time_start（可选）、maintenance_time_end（可选）

**SQL：**
```sql
SELECT m.*, e.model, e.workshop_id, w.workshop_name 
FROM maintenance m 
LEFT JOIN equipment e ON m.equipment_id = e.equipment_id 
LEFT JOIN workshop w ON e.workshop_id = w.workshop_id 
WHERE 1=1
  AND (? IS NULL OR m.equipment_id = ?)
  AND (? IS NULL OR e.workshop_id = ?)
  AND (? IS NULL OR m.fault_type = ?)
  AND (? IS NULL OR m.maintenance_time >= ?)
  AND (? IS NULL OR m.maintenance_time <= ?)
ORDER BY m.maintenance_time DESC;
```

**说明**：三表连接查询，支持多条件筛选，按维修时间倒序排列。

#### 2.2 查询设备维修历史

**功能**：查询指定设备的所有维修记录。

**输入参数**：equipment_id

**SQL：**
```sql
SELECT m.*, e.model, w.workshop_name 
FROM maintenance m 
LEFT JOIN equipment e ON m.equipment_id = e.equipment_id 
LEFT JOIN workshop w ON e.workshop_id = w.workshop_id 
WHERE m.equipment_id = ? 
ORDER BY m.maintenance_time DESC;
```

**说明**：查询指定设备的完整维修历史，按时间倒序排列。

#### 2.3 新增维修记录

**功能**：添加新的维修记录。

**输入参数**：maintenance_id, equipment_id, maintenance_time, fault_description, fault_type, maintenance_cost

**SQL：**
```sql
INSERT INTO maintenance (maintenance_id, equipment_id, maintenance_time, fault_description, fault_type, maintenance_cost) 
VALUES (?, ?, ?, ?, ?, ?);
```

**说明**：插入新维修记录，系统自动设置created_at和updated_at字段。

#### 2.4 修改维修记录

**功能**：更新维修记录信息。

**输入参数**：maintenance_id（WHERE条件），其他字段可选

**SQL：**
```sql
UPDATE maintenance 
SET equipment_id = ?, maintenance_time = ?, fault_description = ?, fault_type = ?, maintenance_cost = ? 
WHERE maintenance_id = ?;
```

**说明**：根据维修单号更新维修记录信息。

#### 2.5 删除维修记录

**功能**：删除维修记录。

**输入参数**：maintenance_id

**SQL：**
```sql
DELETE FROM maintenance WHERE maintenance_id = ?;
```

**说明**：根据维修单号删除维修记录。

### 3. 统计分析API

#### 3.1 车间设备统计

**功能**：统计各车间的设备总数、在用设备数、维修次数。

**SQL：**
```sql
SELECT 
    w.workshop_id,
    w.workshop_name,
    COUNT(e.equipment_id) as total_equipment,
    SUM(CASE WHEN e.status = '在用' THEN 1 ELSE 0 END) as in_use_count,
    COUNT(m.maintenance_id) as total_maintenance_times
FROM workshop w
LEFT JOIN equipment e ON w.workshop_id = e.workshop_id
LEFT JOIN maintenance m ON e.equipment_id = m.equipment_id
GROUP BY w.workshop_id, w.workshop_name
ORDER BY w.workshop_id;
```

**说明**：三表连接，使用GROUP BY和聚合函数统计各车间的设备情况。

#### 3.2 维修趋势统计

**功能**：按月统计维修次数和维修费用，支持按设备或车间筛选。

**输入参数**：equipment_id（可选）、workshop_id（可选）、start_month（可选）、end_month（可选）

**SQL：**
```sql
SELECT 
    DATE_FORMAT(maintenance_time, '%Y-%m') as month,
    COUNT(*) as maintenance_count,
    SUM(maintenance_cost) as total_cost
FROM maintenance m
LEFT JOIN equipment e ON m.equipment_id = e.equipment_id
WHERE 1=1
  AND (? IS NULL OR m.equipment_id = ?)
  AND (? IS NULL OR e.workshop_id = ?)
  AND (? IS NULL OR DATE_FORMAT(maintenance_time, '%Y-%m') >= ?)
  AND (? IS NULL OR DATE_FORMAT(maintenance_time, '%Y-%m') <= ?)
GROUP BY DATE_FORMAT(maintenance_time, '%Y-%m')
ORDER BY month;
```

**说明**：使用DATE_FORMAT函数按月分组统计，支持多条件筛选。

#### 3.3 设备状态统计

**功能**：统计各状态的设备数量。

**SQL：**
```sql
SELECT 
    status,
    COUNT(*) as count
FROM equipment
GROUP BY status;
```

**说明**：按设备状态分组统计各状态的设备数量。

## 创建触发器（如果需要的话）
给出对应的SQL和说明

创建触发器，当设备状态更新为"维修"时，自动记录日志（示例）：

```sql
DELIMITER $$

CREATE TRIGGER trg_equipment_status_update
AFTER UPDATE ON equipment
FOR EACH ROW
BEGIN
    IF OLD.status != NEW.status AND NEW.status = '维修' THEN
        -- 可以在这里插入日志记录或其他操作
        -- INSERT INTO equipment_log (equipment_id, old_status, new_status, update_time) 
        -- VALUES (NEW.equipment_id, OLD.status, NEW.status, NOW());
    END IF;
END$$

DELIMITER ;
```

**说明**：创建触发器监控设备状态变更，当状态变为"维修"时执行相应操作（本示例中注释掉了具体操作，可根据实际需求实现）。

## 创建存储过程（如果需要的话）
创建存储过程，用于批量更新设备状态（示例）：

```sql
DELIMITER $$

CREATE PROCEDURE sp_update_equipment_status(
    IN p_workshop_id VARCHAR(50),
    IN p_old_status VARCHAR(20),
    IN p_new_status VARCHAR(20)
)
BEGIN
    UPDATE equipment 
    SET status = p_new_status 
    WHERE workshop_id = p_workshop_id AND status = p_old_status;
    
    SELECT ROW_COUNT() as affected_rows;
END$$

DELIMITER ;
```

**说明**：创建存储过程，批量更新指定车间、指定状态的设备为新状态，返回受影响的行数。

**调用示例：**
```sql
CALL sp_update_equipment_status('WS001', '在用', '维修');
```

## 数据库的安全性设计
### 1. 创建数据库用户

```sql
-- 创建应用用户（学号3123004792 梁奕航）
CREATE USER 'equipment_user'@'localhost' IDENTIFIED BY 'secure_password_3123004792';
CREATE USER 'equipment_user'@'%' IDENTIFIED BY 'secure_password_3123004792';
```

**说明**：创建数据库用户，分别允许本地和远程连接。

### 2. 权限分配

```sql
-- 授予equipment_management数据库的所有权限
GRANT SELECT, INSERT, UPDATE, DELETE ON equipment_management.* TO 'equipment_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON equipment_management.* TO 'equipment_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

**说明**：授予用户对equipment_management数据库的增删改查权限，不授予CREATE、DROP等管理权限，提高安全性。

### 3. 创建只读用户（用于报表查询）

```sql
-- 创建只读用户
CREATE USER 'equipment_readonly'@'localhost' IDENTIFIED BY 'readonly_password_3123004792';

-- 授予只读权限
GRANT SELECT ON equipment_management.* TO 'equipment_readonly'@'localhost';

FLUSH PRIVILEGES;
```

**说明**：创建只读用户，仅用于查询操作，适用于报表系统等只读场景。

## 数据库实施
数据库备份和恢复方案（给出具体方案）；

### 1. 使用mysqldump进行逻辑备份

**完整备份：**
```bash
mysqldump -u root -p equipment_management > backup_equipment_management_$(date +%Y%m%d).sql
```

**备份说明**：备份整个equipment_management数据库，文件名包含日期，便于管理。

**备份特定表：**
```bash
mysqldump -u root -p equipment_management workshop equipment maintenance > backup_tables_$(date +%Y%m%d).sql
```

**压缩备份：**
```bash
mysqldump -u root -p equipment_management | gzip > backup_equipment_management_$(date +%Y%m%d).sql.gz
```

### 2. 恢复数据库

**从完整备份恢复：**
```bash
mysql -u root -p equipment_management < backup_equipment_management_20241201.sql
```

**从压缩备份恢复：**
```bash
gunzip < backup_equipment_management_20241201.sql.gz | mysql -u root -p equipment_management
```

### 3. 自动化备份脚本

创建备份脚本`backup.sh`（学号3123004792 梁奕航）：

```bash
#!/bin/bash
# 数据库备份脚本
# 作者：梁奕航 学号：3123004792

DB_NAME="equipment_management"
DB_USER="root"
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_${DB_NAME}_${DATE}.sql.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -u $DB_USER -p$DB_PASSWORD $DB_NAME | gzip > $BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "backup_${DB_NAME}_*.sql.gz" -mtime +7 -delete

echo "备份完成: $BACKUP_FILE"
```

**说明**：自动化备份脚本，每天执行一次，保留7天的备份文件。

### 4. 定时备份（使用crontab）

```bash
# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

## 用户界面的设计和实现、应用程序编码
### 1. 数据库连接配置（Node.js/TypeScript）

**文件：packages/backend/src/config/database.ts**

```typescript
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

// 学号3123004792 梁奕航
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
dotenv.config({ path: join(__dirname, '../../.env') });

const pool = mysql.createPool({
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || '',
  database: process.env.DB_NAME || 'equipment_management',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
});

export default pool;
```

**说明**：使用连接池管理数据库连接，提高性能和资源利用率。

### 2. 设备查询API实现

**文件：packages/backend/src/routes/equipment.ts（部分代码）**

```typescript
import express, { Router } from 'express';
import pool from '../config/database.js';

const router: Router = express.Router();

// 获取所有设备（支持查询和筛选）
router.get('/', async (req, res) => {
  try {
    const { equipment_id, model, workshop_id, status, keyword } = req.query;
    let sql = 'SELECT e.*, w.workshop_name FROM equipment e LEFT JOIN workshop w ON e.workshop_id = w.workshop_id WHERE 1=1';
    const params: any[] = [];

    if (equipment_id) {
      sql += ' AND e.equipment_id = ?';
      params.push(equipment_id);
    }
    if (model) {
      sql += ' AND e.model LIKE ?';
      params.push(`%${model}%`);
    }
    if (workshop_id) {
      sql += ' AND e.workshop_id = ?';
      params.push(workshop_id);
    }
    if (status) {
      sql += ' AND e.status = ?';
      params.push(status);
    }
    if (keyword) {
      sql += ' AND (e.equipment_id LIKE ? OR e.model LIKE ? OR w.workshop_name LIKE ?)';
      const keywordPattern = `%${keyword}%`;
      params.push(keywordPattern, keywordPattern, keywordPattern);
    }

    sql += ' ORDER BY e.equipment_id';

    const [rows] = await pool.execute(sql, params);
    res.json({ success: true, data: rows });
  } catch (error: any) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

**说明**：使用参数化查询防止SQL注入，支持多条件动态查询。

### 3. 设备新增API实现

```typescript
// 新增设备
router.post('/', async (req, res) => {
  try {
    const { equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status } = req.body;
    
    const [result]: any = await pool.execute(
      'INSERT INTO equipment (equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status) VALUES (?, ?, ?, ?, ?, ?, ?)',
      [equipment_id, model, factory_date, purchase_price, workshop_id, responsible_person, status]
    );
    
    res.json({ success: true, data: { id: result.insertId, equipment_id } });
  } catch (error: any) {
    if (error.code === 'ER_DUP_ENTRY') {
      return res.status(400).json({ success: false, error: '设备编号已存在' });
    }
    res.status(500).json({ success: false, error: error.message });
  }
});
```

**说明**：使用参数化查询插入数据，处理主键冲突等异常情况。

### 4. 前端API调用（React/TypeScript）

**文件：packages/frontend/src/api/equipment.ts**

```typescript
import { apiClient } from './client';
import type { Equipment, EquipmentQuery } from './types';

export const equipmentApi = {
  // 获取设备列表
  getList: async (params?: EquipmentQuery) => {
    const response = await apiClient.get<{ success: boolean; data: Equipment[] }>('/equipment', { params });
    return response.data;
  },

  // 获取设备详情
  getDetail: async (id: string) => {
    const response = await apiClient.get<{ success: boolean; data: Equipment }>(`/equipment/${id}`);
    return response.data;
  },

  // 新增设备
  create: async (data: Omit<Equipment, 'created_at' | 'updated_at'>) => {
    const response = await apiClient.post<{ success: boolean; data: { id: number; equipment_id: string } }>('/equipment', data);
    return response.data;
  },

  // 更新设备
  update: async (id: string, data: Partial<Equipment>) => {
    const response = await apiClient.put<{ success: boolean; message: string }>(`/equipment/${id}`, data);
    return response.data;
  },

  // 删除设备
  delete: async (id: string) => {
    const response = await apiClient.delete<{ success: boolean; message: string }>(`/equipment/${id}`);
    return response.data;
  },
};
```

**说明**：封装前端API调用，使用TypeScript类型定义保证类型安全。

### 5. 前端组件调用示例

**文件：packages/frontend/src/pages/EquipmentList.tsx（部分代码）**

```typescript
import { equipmentApi } from '../api/equipment';

const EquipmentList = () => {
  const [equipmentList, setEquipmentList] = useState<Equipment[]>([]);

  const loadEquipmentList = async (params?: EquipmentQuery) => {
    try {
      const response = await equipmentApi.getList(params);
      setEquipmentList(response.data);
    } catch (error: any) {
      message.error('加载设备列表失败: ' + error.message);
    }
  };

  useEffect(() => {
    loadEquipmentList();
  }, []);

  // ... 其他代码
};
```

**说明**：React组件中使用API调用获取数据，使用useEffect和useState管理状态。

# 与数据库内容相关的测试

给出系统中与数据库内容相关的测试方案和测试结果报告，比如一些截图。
这一部分需要至少包括增删改查内容的测试。



# 安装和使用说明
简单给出你的软件系统如何部署，需要什么样的软件，硬件。让用户通过阅读这一部分的文档可以从你给出的软件包开始将整个系统运行起来。


## 安装步骤
### 1. 安装Node.js和pnpm

**Windows/macOS：**
- 访问 https://nodejs.org/ 下载并安装Node.js
- 安装pnpm：`npm install -g pnpm`



### 2. 安装MySQL数据库

**Windows：**
- 访问 https://dev.mysql.com/downloads/mysql/ 下载MySQL安装程序
- 运行安装程序，设置root用户密码

**macOS：**
```bash
brew install mysql
brew services start mysql
```

**Linux：**
```bash
sudo apt-get update
sudo apt-get install mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql
```


### 3. 安装项目依赖

```bash
# 在项目根目录执行
pnpm install
```

**说明**：这会自动安装前端、后端和数据库脚本的所有依赖。

### 4. 配置数据库

#### 4.1 创建数据库

```bash
# 登录MySQL
mysql -u root -p

# 执行数据库初始化脚本
source packages/database/init.sql
```

或在MySQL命令行中直接执行：
```sql
CREATE DATABASE IF NOT EXISTS equipment_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE equipment_management;
source packages/database/init.sql;
```

#### 4.2 导入初始数据（可选）

```bash
mysql -u root -p equipment_management < packages/database/seed.sql
```

#### 4.3 配置数据库连接

创建 `packages/backend/.env` 文件：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=你的MySQL密码
DB_NAME=equipment_management
PORT=3001
```

**注意**：请将"你的MySQL密码"替换为实际的MySQL root密码。

### 5. 启动项目

#### 方式一：同时启动前端和后端（推荐）

```bash
# 在项目根目录执行
pnpm dev
```

这将同时启动：
- 前端服务：http://localhost:3000
- 后端服务：http://localhost:3001

#### 方式二：分别启动

**启动后端：**
```bash
cd packages/backend
pnpm dev
```

**启动前端（新终端）：**
```bash
cd packages/frontend
pnpm dev
```

### 6. 访问系统

打开浏览器，访问：http://localhost:3000

## 使用说明

### 1. 设备管理
- **查看设备列表**：进入系统后默认显示设备列表页面
- **搜索设备**：在搜索框输入设备编号、型号或车间名称进行搜索
- **筛选设备**：使用状态、车间下拉框进行筛选
- **新增设备**：点击"新增设备"按钮，填写设备信息后保存
- **编辑设备**：点击设备行的"编辑"按钮，修改信息后保存
- **删除设备**：点击"删除"按钮（注意：有维修记录的设备无法删除）
- **查看详情**：点击设备编号可查看设备详情和维修历史

### 2. 维修记录管理
- **查看维修记录**：点击导航栏"维修记录"菜单
- **筛选记录**：可按设备、车间、故障类型、时间范围筛选
- **新增维修记录**：点击"新增维修记录"按钮，填写信息后保存
- **编辑维修记录**：点击记录行的"编辑"按钮进行修改
- **删除维修记录**：点击"删除"按钮删除记录

### 3. 统计分析
- **车间统计**：点击"统计分析"菜单，查看各车间的设备统计
- **设备状态统计**：查看在用、维修、报废设备的数量分布
- **维修趋势**：查看按月统计的维修次数和费用趋势，支持按车间或设备筛选

## 常见问题

### 1. 端口被占用

**问题**：启动时提示端口3000或3001被占用

**解决**：
```bash
# 查找占用端口的进程
lsof -ti:3000  # 前端端口
lsof -ti:3001  # 后端端口

# 终止进程
kill -9 $(lsof -ti:3000)
kill -9 $(lsof -ti:3001)
```

### 2. 数据库连接失败
**问题**：后端启动后无法连接数据库

**解决**：
1. 检查MySQL服务是否启动：`mysql -u root -p`
2. 检查`.env`文件中的数据库配置是否正确
3. 确认数据库已创建：`SHOW DATABASES;`
4. 确认数据库用户权限

### 3. 前端页面空白

**问题**：浏览器访问页面显示空白

**解决**：
1. 打开浏览器开发者工具（F12），查看Console错误
2. 确认后端服务已启动
3. 检查网络请求是否正常（Network标签页）
4. 清除浏览器缓存后重试

### 4. 依赖安装失败

**问题**：`pnpm install`执行失败

**解决**：
```bash
# 清除缓存
pnpm store prune

# 删除node_modules重新安装
rm -rf node_modules packages/*/node_modules
pnpm install
```

## 项目结构说明

```
guanlixitong/
├── packages/
│   ├── frontend/          # React前端应用
│   │   ├── src/
│   │   │   ├── pages/     # 页面组件
│   │   │   ├── components/# 通用组件
│   │   │   └── api/       # API调用
│   │   └── package.json
│   ├── backend/           # Node.js后端服务
│   │   ├── src/
│   │   │   ├── routes/    # API路由
│   │   │   ├── config/    # 配置文件
│   │   │   └── types/     # TypeScript类型
│   │   └── package.json
│   └── database/          # 数据库脚本
│       ├── init.sql       # 数据库初始化
│       └── seed.sql       # 初始数据
├── package.json           # Monorepo根配置
└── pnpm-workspace.yaml    # pnpm工作区配置
```

# 课程设计总结
通过本次数据库课程设计，我完成了一个完整的工业设备台账管理系统的设计与实现。以下是本次课程设计的总结：

## 完成的工作
### 1. 数据库设计
- **概念设计**：完成了ER图设计，明确了车间、设备、维修记录三个实体及其关系
- **逻辑设计**：将ER图转换为关系模式，分析了函数依赖，确保所有表达到3NF
- **物理设计**：设计了三个数据表的结构，包括字段类型、约束、索引等

### 2. 数据库实现
- **SQL脚本编写**：完成了数据库创建、表创建、索引创建等SQL脚本
- **数据完整性**：通过主键、外键、CHECK约束等保证数据完整性
- **性能优化**：创建了合适的索引以提高查询性能

### 3. 应用程序开发
- **后端开发**：使用Node.js + Express实现了RESTful API，包括设备的增删改查、维修记录管理、统计分析等功能
- **前端开发**：使用React + TypeScript开发了用户界面，实现了设备管理、维修记录管理、统计分析等页面
- **API设计**：设计了完整的API接口，支持多条件查询、多表连接查询等复杂操作

### 4. 测试验证

- **功能测试**：完成了增删改查功能的测试
- **数据完整性测试**：验证了外键约束、CHECK约束等
- **复杂查询测试**：测试了多表连接查询、统计分析查询等

## 收获与体会

### 1. 数据库理论知识应用
通过本次设计，我深入理解了数据库设计的三个层次（概念、逻辑、物理），掌握了ER图设计、关系模式转换、范式分析等理论知识，并将其应用到实际项目中。

### 2. 数据库设计能力提升
学会了如何根据需求分析设计数据库结构，如何通过范式理论优化数据库设计，如何通过索引、约束等提高数据库性能和保证数据完整性。

### 3. 全栈开发能力
通过前后端分离的开发、单仓管理的方式，我掌握了：
- 后端API设计和实现
- 数据库连接和操作
- 前端页面开发和API调用
- 前后端联调

### 4. 问题解决能力
在开发过程中遇到了各种问题，如数据库连接配置、SQL查询优化、前后端数据格式转换等，通过查阅资料和调试，提高了问题解决能力。

## 遇到的困难与解决方案

### 1. 数据库外键约束问题
**问题**：删除设备时，如果设备有维修记录，删除会失败。
**解决**：在删除前检查设备是否有维修记录，如果有则提示用户无法删除，保证了数据的完整性。

### 2. 多表连接查询性能
**问题**：多表连接查询在数据量大时性能较差。
**解决**：创建了合适的索引，如equipment表的workshop_id索引、maintenance表的equipment_id和maintenance_time联合索引等，显著提高了查询性能。

### 3. 前后端数据格式不一致
**问题**：后端返回的日期格式与前端期望的格式不一致。
**解决**：在前端进行数据格式转换，统一处理日期格式，确保数据显示正确。

## 系统特点
1. **数据完整性**：通过外键约束、CHECK约束等保证数据完整性
2. **查询性能**：通过合理的索引设计提高查询性能
3. **用户体验**：界面美观，操作便捷，反馈及时
4. **代码质量**：使用TypeScript提高代码质量，使用参数化查询防止SQL注入
5. **可扩展性**：采用模块化设计，便于后续功能扩展

## 改进方向
1. **用户权限管理**：可以添加用户登录、角色权限管理等功能
2. **数据导出**：可以添加数据导出Excel、PDF等功能
3. **数据可视化**：可以添加更丰富的图表展示，如饼图、柱状图等
4. **移动端适配**：可以开发移动端应用，方便现场操作
5. **数据备份**：可以添加自动备份功能，提高数据安全性
